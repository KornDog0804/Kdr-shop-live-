<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>KDR Admin</title>
<link rel="stylesheet" href="/styles.css"/>
<style>
  .wrap{max-width:1120px;margin:0 auto;padding:22px}
  .row{display:grid;grid-template-columns:1fr 340px;gap:18px}
  textarea{width:100%;min-height:60vh;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:#0b1220;color:#e5e7eb;padding:12px}
  .lib{background:#0b1220;border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:10px;max-height:60vh;overflow:auto}
  .thumb{display:grid;grid-template-columns:70px 1fr;gap:8px;align-items:center;border-bottom:1px solid rgba(255,255,255,.06);padding:6px 2px}
  .thumb img{width:70px;height:70px;object-fit:cover;border-radius:8px;border:1px solid rgba(255,255,255,.1)}
  .preview{margin-top:16px;padding:12px;border:1px dashed rgba(255,255,255,.2);border-radius:12px}
</style>
<script>
  // Simple local password gate (requested)
  (function(){
    const ok = localStorage.getItem('kdr_admin_ok')==='1';
    if(!ok){
      const pass = prompt('Admin password:');
      if(pass!=='fuckthehackers1!'){ location.href='/'; }
      else{ localStorage.setItem('kdr_admin_ok','1'); }
    }
  })();
</script>
</head>
<body>
<div class="wrap">
  <header style="display:flex;align-items:center;justify-content:space-between">
    <h1>KDR Admin</h1>
    <a href="/" class="btn">← Back to site</a>
  </header>

  <div style="display:flex;gap:8px;align-items:center;margin:8px 0 12px">
    Key:&nbsp;<input id="key" value="content/live.json" style="width:280px;border-radius:10px;border:1px solid #334155;padding:8px;background:#0b1220;color:#e5e7eb"/>
    <button id="load" class="btn">Load</button>
    <button id="save" class="btn primary">Save to UpCloud</button>
  </div>

  <div class="row">
    <div>
      <textarea id="editor" spellcheck="false"></textarea>
      <div class="preview" id="preview">
        <strong>Live Preview</strong>
        <div id="p-kitties" class="grid" style="margin-top:8px"></div>
      </div>
      <div id="out" class="muted" style="margin-top:8px">…</div>
    </div>
    <div class="lib">
      <div style="display:flex;align-items:center;justify-content:space-between">
        <strong>Bucket Library</strong>
        <button id="refresh" class="btn">Refresh</button>
      </div>
      <div id="lib">Loading…</div>
    </div>
  </div>
</div>

<script type="module">
  const API='/.netlify/functions';
  const keyEl=document.getElementById('key');
  const ed=document.getElementById('editor');
  const out=document.getElementById('out');
  const lib=document.getElementById('lib');
  const pK=document.getElementById('p-kitties');

  function renderPreview(){
    try{
      const data=JSON.parse(ed.value||'{}');
      const items=(data.sections?.[0]?.items)||[];
      pK.innerHTML=items.slice(0,4).map(it=>`
        <div class="card"><div class="card-inner">
          <div class="face"><img src="${it.image||''}" alt="${it.title||''}"/></div>
          <div class="face back"><div class="pad"><div style="font-weight:800">${it.title||''}</div><div class="muted">$${Number(it.price||0).toFixed(2)}</div></div></div>
        </div></div>
      `).join('');
    }catch(_){ /* ignore */ }
  }
  ed.addEventListener('input', renderPreview);

  async function load(){
    const r=await fetch(`${API}/get-content?key=${encodeURIComponent(keyEl.value)}`);
    const j=await r.json(); ed.value=JSON.stringify(j,null,2); out.textContent='Loaded ✓'; renderPreview();
  }
  async function save(){
    try{
      const body=JSON.parse(ed.value);
      const r=await fetch(`${API}/publish`,{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify({key:keyEl.value,data:body})});
      const j=await r.json();
      out.textContent=j.ok?'Saved ✓':('Save failed: '+(j.error||j));
    }catch(e){ out.textContent='Invalid JSON'; }
  }
  async function refresh(){
    lib.innerHTML='Loading…';
    const r=await fetch(`${API}/list`); const j=await r.json();
    const files=j.files||[];
    lib.innerHTML=files.map(f=>`
      <div class="thumb" data-url="${f.url}">
        <img src="${f.url}" alt="${f.key}"/><div>${f.key}</div>
      </div>
    `).join('');
    lib.querySelectorAll('.thumb').forEach(t=>{
      t.addEventListener('click', ()=>{
        const url=t.getAttribute('data-url');
        try{
          const d=JSON.parse(ed.value||'{}'); d.hero=d.hero||{}; d.hero.image=url;
          ed.value=JSON.stringify(d,null,2); renderPreview();
          navigator.clipboard.writeText(url);
          out.textContent='Hero updated & URL copied.';
        }catch(_){}
      });
    });
  }
  document.getElementById('load').onclick=load;
  document.getElementById('save').onclick=save;
  document.getElementById('refresh').onclick=refresh;
  load().then(refresh);
</script>
</body>
</html>
